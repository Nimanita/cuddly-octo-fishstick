# Use a lightweight Python image
FROM python:3.10-slim

# Ensure output is unbuffered
ENV PYTHONUNBUFFERED=1

# Set working directory
WORKDIR /app

# Install system dependencies: build-essential, gcc, g++, and Node.js
RUN apt-get update && \
    apt-get install -y util-linux build-essential gcc g++ python3-dev curl pkg-config && \
    curl -fsSL https://deb.nodesource.com/setup_16.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Copy the Django backend requirements first, but modify to avoid mysqlclient
COPY backened/code_editor_backened/requirements.txt /app/requirements.

# Install Python dependencies
RUN pip install --upgrade pip && \
    pip install -r /app/requirements.txt && \
    pip install whitenoise daphne

# Copy the backend code to the appropriate location
COPY backened/code_editor_backened /app/

# Copy frontend code
COPY frontend/codyskool /app/frontend/

# Install production dependencies for React app
WORKDIR /app/frontend
RUN npm ci --production

# Build the React app
RUN npm run build

# Move back to the Django project root
WORKDIR /app

# Create a directory for serving static files
RUN mkdir -p staticfiles

# Create a directory for frontend build if it doesn't exist
RUN mkdir -p frontend/build

# Move the built frontend to where Django can serve it
RUN cp -r frontend/build /app/frontend/build

# Collect static files
RUN python manage.py collectstatic --noinput

# Expose the port
EXPOSE 8000

# Start the server with Daphne
CMD ["daphne", "-b", "0.0.0.0", "-p", "8000", "code_editor_backened.asgi:application"]